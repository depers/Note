# 2.主从复制高可用Redis集群

## 第1章 Redis急速入门与复习

### 1-1 分布式架构概述

1. 本阶段规划
   * 分布式缓存中间件Redis
   * 分布式会话与单点登录
   * 分布式搜索引擎Elasticsearch
   * 分布式文件系统
   * 分布式消息队列
   * 分布式锁
   * 数据库读写分离与分库分表
   * 数据库全局唯一主键id设计
   * 分布式事务与数据一致性
   * 接口幂等设计与分布式限流
2. 什么是分布式架构
   * 不同的业务（功能模块）分散部署在不同的服务器
   * 每个子系统负责一个或多个不同的业务模块
   * 服务之间可以相互交互与通信
   * 分布式系统设计对用户透明
   * 可以发展为集群分布式系统架构
3. 分布式架构优点
   * 业务解耦
   * 系统模块化，可重用化
   * 提升系统并发量
   * 优化运维部署效率
4. 分布式架构缺点
   * 架构负载
   * 部署多个子系统复杂
   * 系统之间通信耗时
   * 新人融入团队缓慢
   * 调试复杂
5. 设计原则
   * 异步解耦
   * 幂等一致性（数据库插入和修改）
   * 拆分原则
   * 融合分布式中间件
   * 容错高可用

### 1-2 为何引入Redis？

### 1-3 什么是NoSql？

1. 什么是NoSQL
   * Not Only Sql
   * 传统项目使用纯数据库
   * 为互联网和大数据而生
   * 水平（横向）扩张方便高效
   * 高性能读取
   * 高可用
   * 存数据，做缓存
2. NoSQL常见的分类
   * 键值对数据库：Redis、Memcache
   * 列存储数据库：Hbase、Cassandra
   * 文档型数据库：MongoDB、CouchDB
   * 图形数据库：Neo4J、FlockDB

### 1-4 什么是分布式缓存，什么是Redis？

1. 什么是分布式缓存
   * 提升读取速度性能
   * 分布式计算领域
   * 为数据库降低查询压力
   * 跨服务器缓存
   * 内存式缓存
2. 什么是Redis
   * NoSql
   * 分布式缓存中间件
   * key-value存储
   * 提供海量数据存储访问
   * 数据存储在内存里，读取更快
   * 非关系型、分布式、开源、水平扩展
### 1-5 分布式缓存方案与技术选型：Redis VS Memcache VS Ehcache

1. Ehcache（适合在单体应用）
   * 优点
     * 基于Java开发
     * 基于JVM缓存
     * 简单、轻巧、方便。被Mybatis、Hibernate所采用
   * 缺点
     * 集群不支持
     * 分布式不支持
2. Memcache
   * 优点
     * 简单的key-value存储
     * 内存使用率比较高
     * 多核处理、多线程
   * 缺点
     * 无法容灾，数据无法做到持久化
3. Redis
   * 优点
     * 丰富的数据结构
     * 支持数据持久化
     * 主从同步、故障转移
     * 内存数据库
   * 缺点
     * 单线程
     * 单核

### 1-6 安装与配置Redis

1. 解压redis压缩文件：`tar -zxvf redsi.tar.gz`

2. 编译安装：`make && make install`

3. 复制redis.conf文件放到项目的目录下：`cp redis.conf /usr/local/myapp/mall/Architecture-3/redis`

4. 修改redis.conf文件

   1. 修改`daemonize no`为`daemonize yes`。目的是为了让redis启动在Linux后台运行
   2. 修改redis的工作空间，即持久化目录：`dir /usr/local/myapp/mall/Architecture-3/redis/working`
   3. 修改如下内容，绑定IP为0.0.0.0，代表可以远程连接，不受ip限制：`bind 0.0.0.0`
   4. 设置密码，默认是没有，一定要设置：`requirepass fx1212`

5. 复制redis_init_script文件到`/etc/init.d`文件夹

6. 修改redis_init_script文件，配置redis核心配置文件位置：

   ```shell
   CONF="/usr/local/myapp/mall/Architecture-3/redis/redis.conf"
   ```

7. 为redis启动脚本添加执行权限，随后启动redis：`chmod 777 redis_init_script`、`./redis_init_script`

8. 检查redis进程：`ps -ef|grep redis`

9. 设置redis开机自启动，修改redis_init_script添加如下内容。保存后，随后执行`chkconfig redis_init_script on`：

   ```shell
   #chkconfig: 22345 10 90
   #description: Start and Stop redis
   ```

10. 重启系统`reboot`，查看redis进程：

   ![](E:\markdown笔记\笔记图片\20\2\55.png)

11. 课程安装步骤图：

    ![](E:\markdown笔记\笔记图片\20\2\54.png)

### 1-8 Redis命令行客户端基本使用

> Reids的学习文档：http://redisdoc.com/

1. 启动redis：`redis-cli`

2. 启动redis后，输入密码后才可以进行相关操作：

   ```shell
   127.0.0.1:6379> auth fx1212
   OK
   ```

3. 通过命令验证redis是否还活着：`redis-cli -a fx1212 ping`

   ![](E:\markdown笔记\笔记图片\20\2\56.png)

4. 关闭redis除了使用kill进程外，还可以使用`redis-init-script stop`。但是会报这个错：

   ![](E:\markdown笔记\笔记图片\20\2\57.png)

5.  修改redis_init_script，添加`-a "fx1212"`就能解决上面的问题了：

   ```shell
   $CLIEXEC -a "fx1212" -p $REDISPORT shutdown
   ```

6. 课程笔记图片：

  ![](E:\markdown笔记\笔记图片\20\2\59.png)
  
### 1-10 Redis的数据类型 - string

![](E:\markdown笔记\笔记图片\20\2\60.png)

### 1-12 Redis的数据类型 - hash

![](E:\markdown笔记\笔记图片\20\2\61.png)

### 1-14 Redis的数据类型 - list

![](E:\markdown笔记\笔记图片\20\2\62.png)

### 1-16 Redis的数据类型 - set

* `sadd set a b c c c`：往set中加数据
* `smember set`：查看set的数据
* `sismember set a`：判断a是否在set中
* `srem set a`：从set中删除a
* `spop set`：从set中取出头数据
* `spop set 2`：从set中取出2个头信息
* `srandmember set 3`：从set中随机的获取3个数据
* `smove set1 set2 10`：将10从set1移动到set2
* `sdiff set1 set2`：取set1和set2的差集
* `sinter set1 set2`：取set1和set2的交集
* `sunion set1 set2`：取set1和set2的并集

### 1-17 Redis的数据类型 - zset

![](E:\markdown笔记\笔记图片\20\2\63.png)

## 第2章 SpringBoot整合Redis实战

### 2-1 聊一聊多路复用器，阻塞和非阻塞

**阻塞：**
一个线程占用临界资源，导致其他线程等待挂起

例如：用户发起请求，第一个用户的还未收到响应，后面的用户就必须等待。只有第一个客户收到响应，后面的客户才能和服务器进行交互。

**非阻塞**
没有一个线程可以妨碍其他线程执行的。

例如：服务器收到第一个用户的请求，还没有返回响应，但是他仍然可以处理第二个、第三个用户的请求。

**多路复用器**

这里我们将他比作酒店的接待员，有客户过来询问住酒店的相关事宜，他将相关问题的解释告知客户，这时客户可能要思考一下。然后接待员他就可以为第二、第三个用户去解答问题。他只处理问题的答疑工作，而具体的住酒店手续的办理他不做，这个工作室酒店前台做的。

**这个接待员他只负责接待，他不负责客户的具体服务和处理。**

### 2-2 SpringBoot整合Redis实战

![](E:\markdown笔记\笔记图片\20\2\64.png)

### 2-4 Redis 操作工具类讲解

1. 工具类的工程目录：cn.bravedawn.utils.RedisOperator
2. 代码commit：https://github.com/depers/mall/commit/3359fab9d63ea3af6e55e965ec8980db597678c0

### 2-5 基于Redis优化首页轮播图查询

代码commit：https://github.com/depers/mall/commit/18070c02b373833686988e87457deb6ff19b50e6

### 2-6 基于Redis优化购物车 - 添加商品

代码commit：https://github.com/depers/mall/commit/0299ad12bad4b4a017d6d8eb33fcf392ca80c2f7

### 2-7 Redis 购物车 - 删除商品与更新购买数量

代码commit：https://github.com/depers/mall/commit/643bcb412dc30af2b0ad28f761d08e3fda3d06e2

### 2-8 Redis 购物车 - 清理已结算商品

代码commit：https://github.com/depers/mall/commit/6ea32e67dc73abf5673ddcfb000c41c0bf82e66b

### 2-9 Redis 购物车 - 同步购物车

代码commit：https://github.com/depers/mall/commit/b2cfea664fab67c0210aba582d275bb01a25699b