# 01.分布式会话与单点登录SSO

## 第1章 Redis实现用户会话

### 1-1 实现Redis用户会话

1. 编写conventUser方法，分别运用于cn.bravedawn.controller.PassportController#regist和cn.bravedawn.controller.PassportController#login方法

   ```java
   /**
        * 生成用户token，存入redis会话
        * @param user
        * @return
        */
   private UserVO conventUser(Users user){
       String uniqueToken = UUID.randomUUID().toString().trim();
       redisOperator.set(REDIS_USER_TOKEN + ":" + user.getId(), uniqueToken);
       UserVO userVO = new UserVO();
       BeanUtils.copyProperties(user, userVO);
       userVO.setUserUniqueToken(uniqueToken);
       return userVO;
   }
   ```

2. 在退出登录的方法cn.bravedawn.controller.PassportController#logout中，删除redis中的token信息

   ```java
   // 用户退出登录，清除redis中user的会话信息
   redisOperator.del(REDIS_USER_TOKEN + ":" + userId);
   ```

### 1-2 SpringSession实现用户会话

1. 在pom.xml引入依赖

   ```xml
   <!-- 引入spring session依赖 -->
   <dependency>
   	<groupId>org.springframework.session</groupId>
   	<artifactId>spring-session-data-redis</artifactId>
   </dependency>
   
   <!-- 引入spring安全框架-->
   <dependency>
   	<groupId>org.springframework.boot</groupId>
   	<artifactId>spring-boot-starter-security</artifactId>
   </dependency>
   ```

2. mall-api/src/main/resources/application.yml配置

   ```yml
   spring:
       session:
           store-type: redis             # session的存储类型选redis
   ```

3. 实例代码：cn.bravedawn.controller.HelloController#setSession

4. 在cn.bravedawn.Application中开启基于redis的spring session

   ```java
   // 开启基于redis的spring session
   @EnableRedisHttpSession
   ```

5. 在cn.bravedawn.Application中关闭Spring Security的请求校验：

   ```java
   @SpringBootApplication(exclude = {SecurityAutoConfiguration.class})
   ```


## 第2章 分布式会话拦截器

### 2-1 分布式会话拦截器

1. 拦截器的具体实现，请参考：cn.bravedawn.controller.interceptor.UserTokenInterceptor
2. 拦截器的配置，请参考：cn.bravedawn.config.WebMvcConfig#addInterceptors