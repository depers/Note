## 02.分布式搜索引擎-Elasticsearch

## 第1章

### 1-1 本章概述

1. 本章概述
   * 分布式搜索引擎
   * 搜索引擎技术选型
   * 什么是Elasticsearch？应用场景
   * ES可视化插件、IK分词器、词库
   * ES快速入门、核心术语、文档结构
   * 安装ES，基本操作
   * DSL搜索
   * ES的集群原理
   * ES与数据库数据同步
   * ES与Spring Boot整合实现搜索
   * ES的geo坐标搜索
2. 目前搜索的弊端
   * 空格支持
   * 拆词查询
   * 搜素内容不能高亮
   * 海量数据查库

### 1-2 分布式搜索引擎：lucene vs  solr  vs elasticsearch

1. 什么是分布式搜索引擎
   * 搜索引擎
   * 分布式存储和搜索
2. lucene vs  solr  vs elasticsearch
   * 倒排序索引
   * Lucene是类库
   * Solr基于lucene
   * ES基于lucene
3. ES官网：https://www.elastic.co/cn/

### 1-3 elasticsearch 核心术语

* 索引 index，对应于关系型数据库的**表**
* 类型 type，对应于关系型数据库的**表逻辑类型**（在新版本中已被去掉）
* 文档 document，对应于关系型数据库的**行**（以Json的形式存在）
* 字段 fields，对应于关系型数据库的**列**
* 映射 mapping，对应于关系型数据库的**表结构定义**
* 近实时 NRT，Near real time，新索引和文档的建立和用户的搜索存在一定的延时
* 节点 node，每一个服务器
* shard和replica，数据分片与备份

### 1-5 elasticsearch 集群架构原理

![](E:\markdown笔记\笔记图片\8\59.jpg)

shard是为了将数据分片，提高吞吐量的，保障高性能的；

replica是为了保障在shard宕机情况下，实现高可用的；

### 1-6 什么是倒排索引

![](E:\markdown笔记\笔记图片\8\60.jpg)

### 1-7 安装 elasticsearch

1. 下载es进行解压安装

2. 对elasticsearch.yml进行配置

   * 配置集群名称：

     ```
     cluster.name: mall-elasticSearch
     ```

   * 配置节点名称：

     ```
     node.name: es-node-1
     ```

   * 配置数据存储路径

     ```
     path.data: D:\program_file\elasticsearch-7.8.1\data
     ```

   * 配置日志储存路径

     ```
     path.logs: D:\program_file\elasticsearch-7.8.1\logs
     ```

   * 设置绑定的ip地址，`0.0.0.0`代表可以远程连接，不受ip限制

     ```
     network.host: 0.0.0.0
     ```

   * 配置初始节点

     ```
     cluster.initial_master_nodes: ["es-node-1"]
     ```

3. 对jvm.options进行配置：

   修改总堆空间的初始大小和总堆空间的最大大小：

   ```
   -Xms128m
   -Xmx128m
   ```

4. 使用命令`whoami`查看当前用户，如果是root用户是不允许启动es的，必须新建一个用户去启动。具体命令如下：

   ```
   # 创建用户
   useradd esuser
   
   # 授权,
   # -R : 处理指定目录以及其子目录下的所有文件
   # user : 新的文件拥有者的使用者 ID
   # group : 新的文件拥有者的使用者组(group)
   # chown -R user:group /user/...
   chown -R esuser:esuser /user/local/myapp/elasticsearch-7.8.1
   ```

5. 启动es

   * 前台启动

     ```
     ./elasticsearch
     ```

   * 后台启动，启动之后访问http://localhost:9200/就可以看到es的相关信息

     ```
     ./elasticsearch -d
     ```

   * 后台关闭：

     ```
     jps elasticsearch
     
     kill <进程id>
     ```
   
6. 安装过程中的问题

   ![](E:\markdown笔记\笔记图片\8\68.jpg)

### 1-9 安装es-header插件

* es haeder的github地址：https://github.com/mobz/elasticsearch-head
* 可以在github上下载elasticsearch-Head插件：https://github.com/mobz/elasticsearch-head/blob/master/crx/es-head.crx下载到本地。
* 如果直接拖拽到Chrome会不能使用，告诉你非Chrome来源的。这个时候将文件后缀名".crx"改为“.rar”，然后解压到文件夹里，再通过Chrome“加载已解压的扩展程序”按钮加入文件夹就可以使用了。

## 第2章

### 2-1 head与postman基于索引的基本操作

1. 使用es-head进行相关接口的调用

   ![](E:\markdown笔记\笔记图片\8\72.png)

2. 使用postman进行相关接口的调用

   ![](E:\markdown笔记\笔记图片\8\73.png)

3. 索引相关操作

   1. 创建索引

      ![](E:\markdown笔记\笔记图片\8\74.png)

   2. 刚才我们创建的索引有5个分片，点击概览进行查看

      ![](E:\markdown笔记\笔记图片\8\75.png)

   3. 创建有备份的索引

      ![](E:\markdown笔记\笔记图片\8\76.png)

   4. 查看创建的备份索引，其中只要有5个replica是没有被分配的，导致集群的健康值变为了黄色。

      ![](E:\markdown笔记\笔记图片\8\77.png)
      
   5. 通过Rest请求创建索引，相关的接口可以参照https://www.elastic.co/guide/cn/elasticsearch/guide/current/_creating_an_index.html
   
      * 方法：PUT http://localhost:9200/index_basic
   
      * 请求参数
   
        ```
        {
            "settings": {
                "index": {
                    "number_of_shards": "3",
                    "number_of_replicas": "0"
                }
            }
        }
        ```
   
      * 响应参数，说明创建成功：
   
        ```
        {
            "acknowledged": true,
            "shards_acknowledged": true,
            "index": "index_basic"
        }
        ```
   
   6. 查询一个索引：GET http://localhost:9200/my_index
   
   7. 查询所有索引：GET http://localhost:9200/_cat/indices

### 2-3 mappings自定义创建映射

1. es关于映射的定义：https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html

2. 观察如下自定义创建隐射：

   * 方法：PUT http://localhost:9200/index_mapping

   * 请求参数

     ```
     {
         "mappings": {
             "properties": {
                 "realname": {
                     "type": "text",
                     "index": true
                 },
                 "username": {
                     "type": "keyword",
                     "index": false
                 }
             }
         }
     }
     ```

   其中：

   * type：https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html

     这两个类型都是字符串类型

     * text：https://www.elastic.co/guide/en/elasticsearch/reference/current/text.html
     * keyword：https://www.elastic.co/guide/en/elasticsearch/reference/current/keyword.html

   * index：https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-index.html

   使用chrome插件查看索引信息：

   ![](E:\markdown笔记\笔记图片\20\3\4.png)

### 2-5 mappings新增数据类型与analyze

* Text analysis：文本分析是将非结构化文本（例如电子邮件的正文或产品说明）转换为针对搜索优化的结构化格式的过程。(https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis.html)

* 一个简单的文本分析案例：

  * 方法：GET http://localhost:9200/index_mapping/_analyze

  * 参数：

    ```
    {
        "field": "realname",
        "text": "The quick brown fox."
    }
    ```

  * 响应：

    ```
    {
        "tokens": [
            {
                "token": "the",
                "start_offset": 0,
                "end_offset": 3,
                "type": "<ALPHANUM>",
                "position": 0
            },
            {
                "token": "quick",
                "start_offset": 4,
                "end_offset": 9,
                "type": "<ALPHANUM>",
                "position": 1
            },
            {
                "token": "brown",
                "start_offset": 10,
                "end_offset": 15,
                "type": "<ALPHANUM>",
                "position": 2
            },
            {
                "token": "fox",
                "start_offset": 16,
                "end_offset": 19,
                "type": "<ALPHANUM>",
                "position": 3
            }
        ]
    }
    ```

* mappings新增数据类型

  * mappings字段不能修改和删除，只能添加

  * 文档地址：https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-put-mapping.html

  * 方法：PUT/POST http://localhost:9200/index_mapping/_mapping

  * 请求参数：

    ```
    {
        "properties": {
            "id": {
                "type": "long"
            },
            "age": {
                "type": "integer"
            },
            "money": {
              	"type": "float"
            },
            "tax": {
                "type": "double" 
            },
            "email": {
            	"type": "keyword"
            },
            "sex": {
              "type": "byte"
            },
            "score": {
                "type": "short"
            },
            "is_teegner": {
              	"type": "boolean"
            },
            "brithday": {
                "type": "date"
            },
            "relationShip": {
              	"type": "object"
            }
        }
    }
    ```

  * 响应参数：

    ```
    {
        "acknowledged": true
    }
    ```

  * 新增数据类型的mappings

    ![](E:\markdown笔记\笔记图片\20\3\5.png)

### 2-6 文档的基本操作 - 添加文档与自动映射

#### 1.添加文档

1. 创建一个分片为1，副本为0的索引

2. 使用postman创建文档：

   * 请求url（`http://localhost:9200/my_doc/_doc/1`）中的最后一个数字是**文档Id**；
   * 请求报文是文档的相关内容；
   * 响应报文`result`为`created`表示创建成功；

   ![](E:\markdown笔记\笔记图片\20\3\6.png)

3. 插入后的结果：

   ![](E:\markdown笔记\笔记图片\20\3\7.png)

#### 2.自动映射

Elasticsearch的最重要功能之一是它试图摆脱束缚，让您尽快开始探索数据。 要为文档建立索引，您不必先创建索引，定义映射类型并定义字段-您只需为文档建立索引，索引，类型和字段就会自动生效。如下图所示：

![8](E:\markdown笔记\笔记图片\20\3\8.png)

### 2-8 文档的基本操作 - 删除与修改

按照上一节的内容我们往索引中添加几个文档。

![](E:\markdown笔记\笔记图片\20\3\9.png)

#### 1.删除文档

1. 删除id为4的文档；

2. 使用postman删除文档：

   * 请求url（`http://localhost:9200/my_doc/_doc/1`）中的最后一个数字是**文档Id**，是**DELETE**请求；
   * 响应result为deleted为删除成功，_version为2表示这是修改的第二个版本，es不会直接删除这个文档，而是在合适的时候才会去删除。

   ![](E:\markdown笔记\笔记图片\20\3\10.png)

#### 2.修改文档

1. 修改id为2的文档的name字段，对文档的局部属性进行修改

2. 使用postman修改文档：

   * 请求url（`http://localhost:9200/my_doc/_doc/2/_update`）中的最后一个数字是**文档Id**，是POST请求；
   * 响应result为updated为修改成功。

   ![](E:\markdown笔记\笔记图片\20\3\11.png)

3. 全量字段修改

   * 请求地址`http://localhost:9200/my_doc/_doc/3`，请求方式为PUT
   * 请求报文中需要写全量字段

   ![](E:\markdown笔记\笔记图片\20\3\12.png)

### 2-10 文档的基本操作 - 查询

#### 1.文档全文的查询

* 请求地址：GET http://localhost:9200/my_doc/_doc/2

* 响应参数：其中_source是文档的全文

  ![](E:\markdown笔记\笔记图片\20\3\13.png)

#### 2.查询所有文档数据

* 请求地址：GET http://localhost:9200/my_doc/_doc/_search

* 响应参数：其中hits数组是所有的文档

  ![](E:\markdown笔记\笔记图片\20\3\14.png)

#### 3.元数据字段

参考文档：https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-fields.html#mapping-fields

* _index：文档数据所属那个索引，理解为数据库的某张表即可。
* \_type：文档数据属于哪个类型，新版本使用_doc 。_
* _id：文档数据的唯一标识，类似数据库中某张表的主键。可以自动生成或者手动指定。
* _score：查询相关度，是否契合用户匹配，分数越高用户的搜索体验越高。
* _version：版本号。
* _source：文档数据，json格式。

![](E:\markdown笔记\笔记图片\20\3\15.png)

#### 4.定制化数据查询

* 请求地址：GET http://localhost:9200/my_doc/_doc/2?_source=id，只要原始json的id字段
* 响应参数：其中_source是查询的结果![](E:\markdown笔记\笔记图片\20\3\16.png)

#### 5.定制化数据查询所有数据

* 请求地址：GET http://localhost:9200/my_doc/_doc/_search?_source=id,name，只要原始json的id字段

* 响应参数：其中_source是查询的结果

  ![](E:\markdown笔记\笔记图片\20\3\17.png)

#### 6.判断某个文档在不在-head请求

  按照之前的描述，如果我们想判断某一个文档在不在，是否需要按照之前第1小节所讲的那样发起一个GET请求。

* 使用Get请求，如下图所示响应体的大小是317个字节

  ![](E:\markdown笔记\笔记图片\20\3\18.png)

* 使用Head请求，如下图所示响应体的大小是87个字节，所以如果要判断一个文档是否存在，推荐使用HEAD请求。

    ![](E:\markdown笔记\笔记图片\20\3\19.png)
    
### 2-12 文档乐观锁控制 if_seq_no与if_primary_term

根据上一节的讲解，每一个文档中都有一些元数据，元数据中包含的`_version：版本号`，他其实就是用来实现乐观锁的。

#### 1.创建、查询、修改文档

1. 创建文档

   ![](E:\markdown笔记\笔记图片\20\3\20.png)

2. 查询文档

   ![](E:\markdown笔记\笔记图片\20\3\21.png)

3. 局部修改文档

   ![](E:\markdown笔记\笔记图片\20\3\22.png)

#### 2.乐观锁控制

参考文档：https://www.elastic.co/guide/en/elasticsearch/reference/7.9/optimistic-concurrency-control.html#optimistic-concurrency-control

为确保文档的较旧版本不会覆盖较新的版本，对文档执行的每项操作均由主分片分配一个序号，以协调更改。 每次操作都会增加**序列号**，因此可以确保较新的操作具有比较旧的操作更高的序列号。 然后，Elasticsearch可以使用操作的序列号来确保分配给它的序列号较小的更改不会覆盖较新的文档版本。

通过查询接口，我们可以看到响应的_seq_no和_primary_term字段中看到分配的序列号和主要术语：

![](E:\markdown笔记\笔记图片\20\3\23.png)

序列号和主要术语唯一地标识更改。 通过记下返回的序列号和主要术语，可以确保仅在检索以来**未对其进行任何其他更改的情况下**，才能更改该文档。 这可以通过设置索引API，更新API或删除API的if_seq_no和if_primary_term参数来完成。

**情况一：乐观锁控制更新失败**

请求地址http://localhost:9200/my_doc/_doc/2001?if_seq_no=7&if_primary_term=4，因为当前的seq_no变为了8，primary term变为了4。版本号高于当前的修改版本，所以版本冲突，更新失败。

![](E:\markdown笔记\笔记图片\20\3\24.png)

**情况二：乐观锁控制更新成功**

请求地址http://localhost:9200/my_doc/_doc/2001?if_seq_no=8&if_primary_term=4，因为当前的seq_no和primary term与更新版本号相同，所以更新成功。

### 2-14 分词与内置分词器

#### 1.分词

参考文档：https://www.elastic.co/guide/en/elasticsearch/reference/7.9/analysis-analyzers.html

如下图所示：

* 请求地址：http://localhost:9200/_analyze
* 请求参数：
  * analyzer 分词器：
    * standard 标准分析器：按照Unicode文本分段算法的定义，将文本划分为单词边界上的各个术语
    * sample 简单分析器：遇到非字母字符时会将文本分为多个词项
    * whitespace 空格分析器：按照空格进行分词
    * stop 结束分析器：去除无意义的单词
    * keyword 关键字分析器：一个“空”分析器，它接受给出的任何文本，并输出与单个术语完全相同的文本
* 响应参数：tokens中的每一个对象包含着响应的分词结果

![](E:\markdown笔记\笔记图片\20\3\26.png)

#### 2.对特定的索引进行分词

如下图请求地址所示，在某一索引下对一段文字进行分词。

关于这部分内容可以参考：https://www.elastic.co/guide/en/elasticsearch/reference/7.9/indices-analyze.html#analyze-api-field-ex

![](E:\markdown笔记\笔记图片\20\3\27.png)

### 2-16 建立ik中文分词器

#### 1.安装ik分词器

ik中文分词器github地址：https://github.com/medcl/elasticsearch-analysis-ik

#### 2.测试ik分词器

中文分词测试，其中将分词器设置为`ik_max_word`。

ik分词器提供了两个分词器选择：`ik_max_word`和`ik_smart`

![](E:\markdown笔记\笔记图片\20\3\28.png)

### 2-18 自定义中文词库

我们利用上一节的中文分词器，分析这么一句话“骚年在慕课网学习”。如下图所示，但是“骚年”这个词并没有被合在一起，“慕课网”这个词也没有被合在一起，遇到这种问题该怎么办。

![](E:\markdown笔记\笔记图片\20\3\29.png)

#### 1. 自定义中文词汇

1. 官方文档https://github.com/medcl/elasticsearch-analysis-ik中的文档如下：

   ```xml
   <!--用户可以在这里配置自己的扩展字典 -->
   <entry key="ext_dict">custom/mydict.dic;custom/single_word_low_freq.dic</entry>
   ```

2. 编辑本地文件**plugins\ik\config\IKAnalyzer.cfg.xml**

   ```xml
   <!--用户可以在这里配置自己的扩展字典 -->
   <entry key="ext_dict">custom.dic</entry>
   ```

3. 编辑**custom.dic**

   ```
   慕课网
   骚年
   ```

4. 接着我们继续做一下本节开始的请求

   ![](E:\markdown笔记\笔记图片\20\3\30.png)

## 第3章 dsl搜索

### 3-1 dsl搜索 - 数据准备

1. 编辑自己扩展的字典，编辑plugins\ik\config\custom.dic

   ```
   慕课网
   骚年
   慕课
   课网
   慕
   课
   网
   ```

2. 创建一个索引**shop**

   ![](E:\markdown笔记\笔记图片\20\3\31.png)

3. 创建映射

   ![](E:\markdown笔记\笔记图片\20\3\32.png)

4. 添加文档，一共录入了12条文档数据

   ![](E:\markdown笔记\笔记图片\20\3\33.png)