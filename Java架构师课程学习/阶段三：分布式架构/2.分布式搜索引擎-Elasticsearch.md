## 02.分布式搜索引擎-Elasticsearch

## 第1章

### 1-1 本章概述

1. 本章概述
   * 分布式搜索引擎
   * 搜索引擎技术选型
   * 什么是Elasticsearch？应用场景
   * ES可视化插件、IK分词器、词库
   * ES快速入门、核心术语、文档结构
   * 安装ES，基本操作
   * DSL搜索
   * ES的集群原理
   * ES与数据库数据同步
   * ES与Spring Boot整合实现搜索
   * ES的geo坐标搜索
2. 目前搜索的弊端
   * 空格支持
   * 拆词查询
   * 搜素内容不能高亮
   * 海量数据查库

### 1-2 分布式搜索引擎：lucene vs  solr  vs elasticsearch

1. 什么是分布式搜索引擎
   * 搜索引擎
   * 分布式存储和搜索
2. lucene vs  solr  vs elasticsearch
   * 倒排序索引
   * Lucene是类库
   * Solr基于lucene
   * ES基于lucene
3. ES官网：https://www.elastic.co/cn/

### 1-3 elasticsearch 核心术语

* 索引 index，对应于关系型数据库的**表**
* 类型 type，对应于关系型数据库的**表逻辑类型**（在新版本中已被去掉）
* 文档 document，对应于关系型数据库的**行**（以Json的形式存在）
* 字段 fields，对应于关系型数据库的**列**
* 映射 mapping，对应于关系型数据库的**表结构定义**
* 近实时 NRT，Near real time，新索引和文档的建立和用户的搜索存在一定的延时
* 节点 node，每一个服务器
* shard和replica，数据分片与备份

### 1-5 elasticsearch 集群架构原理

![](E:\markdown笔记\笔记图片\8\59.jpg)

shard是为了将数据分片，提高吞吐量的，保障高性能的；

replica是为了保障在shard宕机情况下，实现高可用的；

### 1-6 什么是倒排索引

![](E:\markdown笔记\笔记图片\8\60.jpg)

### 1-7 安装 elasticsearch

1. 下载es进行解压安装

2. 对elasticsearch.yml进行配置

   * 配置集群名称：

     ```
     cluster.name: mall-elasticSearch
     ```

   * 配置节点名称：

     ```
     node.name: es-node-1
     ```

   * 配置数据存储路径

     ```
     path.data: D:\program_file\elasticsearch-7.8.1\data
     ```

   * 配置日志储存路径

     ```
     path.logs: D:\program_file\elasticsearch-7.8.1\logs
     ```

   * 设置绑定的ip地址，`0.0.0.0`代表可以远程连接，不受ip限制

     ```
     network.host: 0.0.0.0
     ```

   * 配置初始节点

     ```
     cluster.initial_master_nodes: ["es-node-1"]
     ```

3. 对jvm.options进行配置：

   修改总堆空间的初始大小和总堆空间的最大大小：

   ```
   -Xms128m
   -Xmx128m
   ```

4. 使用命令`whoami`查看当前用户，如果是root用户是不允许启动es的，必须新建一个用户去启动。具体命令如下：

   ```
   # 创建用户
   useradd esuser
   
   # 授权,
   # -R : 处理指定目录以及其子目录下的所有文件
   # user : 新的文件拥有者的使用者 ID
   # group : 新的文件拥有者的使用者组(group)
   # chown -R user:group /user/...
   chown -R esuser:esuser /user/local/myapp/elasticsearch-7.8.1
   ```

5. 启动es

   * 前台启动

     ```
     ./elasticsearch
     ```

   * 后台启动，启动之后访问http://localhost:9200/就可以看到es的相关信息

     ```
     ./elasticsearch -d
     ```

   * 后台关闭：

     ```
     jps elasticsearch
     
     kill <进程id>
     ```
   
6. 安装过程中的问题

   ![](E:\markdown笔记\笔记图片\8\68.jpg)

### 1-9 安装es-header插件

* es haeder的github地址：https://github.com/mobz/elasticsearch-head
* 可以在github上下载elasticsearch-Head插件：https://github.com/mobz/elasticsearch-head/blob/master/crx/es-head.crx下载到本地。
* 如果直接拖拽到Chrome会不能使用，告诉你非Chrome来源的。这个时候将文件后缀名".crx"改为“.rar”，然后解压到文件夹里，再通过Chrome“加载已解压的扩展程序”按钮加入文件夹就可以使用了。

## 第2章

### 2-1 head与postman基于索引的基本操作

1. 使用es-head进行相关接口的调用

   ![](E:\markdown笔记\笔记图片\8\72.png)

2. 使用postman进行相关接口的调用

   ![](E:\markdown笔记\笔记图片\8\73.png)

3. 索引相关操作

   1. 创建索引

      ![](E:\markdown笔记\笔记图片\8\74.png)

   2. 刚才我们创建的索引有5个分片，点击概览进行查看

      ![](E:\markdown笔记\笔记图片\8\75.png)

   3. 创建有备份的索引

      ![](E:\markdown笔记\笔记图片\8\76.png)

   4. 查看创建的备份索引，其中只要有5个replica是没有被分配的，导致集群的健康值变为了黄色。

      ![](E:\markdown笔记\笔记图片\8\77.png)
      
   5. 通过Rest请求创建索引，相关的接口可以参照https://www.elastic.co/guide/cn/elasticsearch/guide/current/_creating_an_index.html
   
      * 方法：PUT http://localhost:9200/index_basic
   
      * 请求参数
   
        ```
        {
            "settings": {
                "index": {
                    "number_of_shards": "3",
                    "number_of_replicas": "0"
                }
            }
        }
        ```
   
      * 响应参数，说明创建成功：
   
        ```
        {
            "acknowledged": true,
            "shards_acknowledged": true,
            "index": "index_basic"
        }
        ```
   
   6. 查询一个索引：GET http://localhost:9200/my_index
   
   7. 查询所有索引：GET http://localhost:9200/_cat/indices

### 2-3 mappings自定义创建映射

1. es关于映射的定义：https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html

2. 观察如下自定义创建隐射：

   * 方法：PUT http://localhost:9200/index_mapping

   * 请求参数

     ```
     {
         "mappings": {
             "properties": {
                 "realname": {
                     "type": "text",
                     "index": true
                 },
                 "username": {
                     "type": "keyword",
                     "index": false
                 }
             }
         }
     }
     ```

   其中：

   * type：https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html

     这两个类型都是字符串类型

     * text：https://www.elastic.co/guide/en/elasticsearch/reference/current/text.html
     * keyword：https://www.elastic.co/guide/en/elasticsearch/reference/current/keyword.html

   * index：https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-index.html

   使用chrome插件查看索引信息：

   ![](E:\markdown笔记\笔记图片\20\3\4.png)

### 2-5 mappings新增数据类型与analyze

* Text analysis：文本分析是将非结构化文本（例如电子邮件的正文或产品说明）转换为针对搜索优化的结构化格式的过程。(https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis.html)

* 一个简单的文本分析案例：

  * 方法：GET http://localhost:9200/index_mapping/_analyze

  * 参数：

    ```
    {
        "field": "realname",
        "text": "The quick brown fox."
    }
    ```

  * 响应：

    ```
    {
        "tokens": [
            {
                "token": "the",
                "start_offset": 0,
                "end_offset": 3,
                "type": "<ALPHANUM>",
                "position": 0
            },
            {
                "token": "quick",
                "start_offset": 4,
                "end_offset": 9,
                "type": "<ALPHANUM>",
                "position": 1
            },
            {
                "token": "brown",
                "start_offset": 10,
                "end_offset": 15,
                "type": "<ALPHANUM>",
                "position": 2
            },
            {
                "token": "fox",
                "start_offset": 16,
                "end_offset": 19,
                "type": "<ALPHANUM>",
                "position": 3
            }
        ]
    }
    ```

* mappings新增数据类型

  * mappings字段不能修改和删除，只能添加

  * 文档地址：https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-put-mapping.html

  * 方法：PUT/POST http://localhost:9200/index_mapping/_mapping

  * 请求参数：

    ```
    {
        "properties": {
            "id": {
                "type": "long"
            },
            "age": {
                "type": "integer"
            },
            "money": {
              	"type": "float"
            },
            "tax": {
                "type": "double" 
            },
            "email": {
            	"type": "keyword"
            },
            "sex": {
              "type": "byte"
            },
            "score": {
                "type": "short"
            },
            "is_teegner": {
              	"type": "boolean"
            },
            "brithday": {
                "type": "date"
            },
            "relationShip": {
              	"type": "object"
            }
        }
    }
    ```

  * 响应参数：

    ```
    {
        "acknowledged": true
    }
    ```

  * 新增数据类型的mappings

    ![](E:\markdown笔记\笔记图片\20\3\5.png)

### 2-6 文档的基本操作 - 添加文档与自动映射