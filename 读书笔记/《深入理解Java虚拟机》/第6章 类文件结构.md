# 第6章 类文件结构

> 2022年10月5日 陕西西安《深入理解Java虚拟机》p162-p167

## 6.2 无关性的基石

* 语言无关性：Java虚拟机上可以支持其他语言运行在JVM上。

* 平台无关性：一次编译，到处运行。

* 字节码：
  1. 是不同JVM和不同平台都统一使用的一种程序存储格式。
  2. Java语言中的各种常量、关键字和运算符号的语义最终都是由多条字节码命令组成的。

## 6.3 Class类文件的结构

* Class文件是一组以8位字节为基础单位的二进制流。

* Big-Endian：是一种字节存储顺序，简称 **高位在前** 或 **大尾序** 或 **大端序**。具体是指最高位字节在地址的最低位，最低位字节在地址最高位，按照这样的顺序来存储数据。

  如下图所示，对于多字节数据，如整数（32位机中一般占4字节），在不同的处理器的存放方式主要有两种，以内存中0x0A0B0C0D的存放方式为例。0x0A是最高字节，他存储在最低的内存地址a处。

  ![](../../笔记图片/29-深入理解Java虚拟机/280px-Big-Endian.svg.png)

  关于这个问题可以参考：https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82%E5%BA%8F

* Class文件采用类似C语言结构体的伪结构存储数据，伪结构包含两种数据类型：**无符号数**和**表**。
* 无符号数：基本数据类型，以u1，u2，u4，u8分别来表示1个字节、2个字节、4个字节和8个字节的无符号数。
* 表：由多个无符号数或其他表作为数据项构成的复合数据类型。

### 6.3.1 魔数和Class文件的版本

* 魔数：Class文件的头4个字节称为魔数。
* 魔数的作用：确定这个文件是否为一个能被虚拟机接受的Class文件。
* Class文件的版本号：紧接着魔数后面的4个字节存储的是Class文件的版本号。第5到6个字节是次版本号，第7到8个字节是主版本号。
* Class文件版本号的作用：确定虚拟机是否可以执行该版本号的Class文件，例如一个Class文件的主版本号是0x0032，十进制是50，50对应JDK 1.6.0_01，也就是说这个Class文件可以被1.6.0_01或以上版本的虚拟机执行。

### 6.3.2 常量池

> 2022年10月10日 陕西西安 第六章 类文件结构 p168-p172页内容的学习

* 常量池的特点
  1. 常量池是Class文件中第一个出现的表类型数据项目。
  2. 常量池的每一项常量都是一个表。
  3. 常量池的第一项是一个u2类型的数据，代表常量池容量计数值（constant_pool_count）。该容器计数（常量池的索引）是从1开始的不是0。0作为预留值，代表“不引用任何一个常量池项目”的含义。
* 常量池存放的两大常量
  * 字面量
  * 符号引用
    * 类和接口的全限定名（Full Qualified Name）
    * 字段的名称和描述符（Descriptor）
    * 方法的名称和描述符
* 常量池的项目类型
  * JDK1.7共有14项项目类型。
  * 14项项目类型都有一个共同的特点，表开始的第一位是一个u1类型的标志位。
  * 可以使用分析Class文件字节码的工具：javap，对字节码文件进行解析。
  * 14种常量项的结构总表，参见本书p172。
* UTF-8的缩写编码表示
  * 参考文章
    * [字符编码笔记：ASCII，Unicode 和 UTF-8](https://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html)

### 6.3.3 访问标志

> 2022年10月21日 陕西西安 第六章 类文件结构 p172-p180页内容的学习

* 访问标志：常量池结束之后的两个字节代表访问标志，用来标识类或接口的访问信息。
* 两个字节一共是16位，每一位为1表示一种情况。目前只定义了8个标识：
  1. 是否为public
  2. 是否为final
  3. 是否允许使用invokespecial字节码指令
  4. 标识这是一个接口
  5. 是否为abstract
  6. 是否是用户编写的代码
  7. 标识这是一个注解
  8. 标识这是一个枚举

### 6.3.4 类索引、父类索引、接口索引集合

* 类索引：
  * 用于确定这个类的类名称。
  * 是一个u2类型的索引值，是指向常量池中类型为CONSTANT_Utf8_info常量的索引值。
* 父类索引：
  * 用于确定这个类的父类的全限定名。
  * 是一个u2类型的索引值，是指向常量池中类型为CONSTANT_Utf8_info常量的索引值。
* 接口索引集合：
  * 用于描述这个类实现了哪些接口。
  * 一组u2类型数据的集合。
  * 第一项的u2类型数据为接口计数器。

### 6.3.5 字段表集合

* 字段表集合的第一个u2类型的数据是 字段表集合的计数器容量，即字段表集合中包含字段表结构的数量。

* 字段表

  * 用于描述接口或者类中声明的变量（字段）。
  * 字段包括类级别变量（`static`关键字）和实例级变量。

* 字段表结构

  | 类型                     | 名称             | 数量             | 中文名         | 作用                                                         |
  | ------------------------ | ---------------- | ---------------- | -------------- | ------------------------------------------------------------ |
  | u2                       | access_flags     | 1                | 字段访问标志   | 标识字段的作用域：<br />1. public, private, protect修饰符<br />2. static修饰符，是实例变量还是类变量<br />3. final修饰符，可变性<br />4. volatile修饰符，并发可见性，是否强制从主内存读写<br />5. transient修饰符，是否可被序列化<br />6. 字段是否是编译器自动生成的<br />7. 字段是否为enum |
  | u2                       | name_index       | 1                | 字段的简单名称 | 字段的名称，例如private String username的简单名称为username。是指向常量池中类型为CONSTANT_Utf8_info常量的一个索引值。 |
  | u2                       | descriptor_index | 1                | 字段的描述符   | 用来描述字段的数据类型。是指向常量池中类型为CONSTANT_Utf8_info常量的一个索引值。<br />![](../../笔记图片/29-深入理解Java虚拟机/JVM描述符标识字段含义.png) |
  | u2                       | attributes_count | 1                | 属性表计数器   | 表示该字段在属性表集合中的属性数量                           |
  | attribute_info（可选项） | attributes       | attributes_count | 属性名称索引   | 指向常量池中常量的索引值，指向常量池中类型为CONSTANT_Utf8_info常量的一个索引值。 |

* 字段表集合中是不会列出从超类或者父接口中继承而来的字段，因为Java语言中字段是无法重载的。

### 6.3.6 方法表集合

* 方法表集合的第一个u2类型的数据是 方法表集合中的计数器容量，即方法表集合中包含方法表结构的数量。

* 方法表结构

  | 类型                     | 名称             | 数量             | 中文名         | 作用                                                         |
  | ------------------------ | ---------------- | ---------------- | -------------- | ------------------------------------------------------------ |
  | u2                       | access_flags     | 1                | 字段访问标志   | 标识字段的作用域：<br />1. public, private, protect修饰符<br />2. static修饰符，是实例变量还是类变量<br />3. final修饰符，可变性<br />4. synchronized修饰符，保证同步<br />5. native修饰符，原生函数<br />6. strictfp修饰符，用来确保浮点数运算的准确性<br />7. abstract修饰符，表示抽象方法<br />8. 字段是否是编译器自动生成的<br />7. 字段是否为enum<br />8. 是否为编译器产生的桥接方法<br />9. 是否接受不定参数 |
  | u2                       | name_index       | 1                | 方法的简单名称 | 方法的名称，例如private String getName()的简单名称为getName。是指向常量池中类型为CONSTANT_Utf8_info常量的一个索引值。 |
  | u2                       | descriptor_index | 1                | 方法的描述符   | 用来描述方法的数据类型。指向常量池中类型为CONSTANT_Utf8_info常量的一个索引值。<br />![](../../笔记图片/29-深入理解Java虚拟机/JVM描述符标识字段含义.png) |
  | u2                       | attributes_count | 1                | 属性表计数器   | 表示该方法在属性表集合中的属性数量                           |
  | attribute_info（可选项） | attributes       | attributes_count | 属性名称索引   | 指向常量池中常量的索引值。是指向常量池中类型为CONSTANT_Utf8_info常量的一个索引值。 |

* Java语言中的特征签名包括：方法名称，参数顺序，参数类型。
* 字节码的特征签名包括：方法名称，参数顺序，参数类型，方法返回值，受查异常表。

### 6.3.7 属性表集合

* 定义：在Class文件、字段表、方法表都可以携带自己的属性表集合，用于描述某些场景专有的信息。
* 特点：
  1. 任何人实现的编译器中都可以向属性表中写入自己定义的属性信息。
  2. Java虚拟机预定义了21项Java虚拟机应当能识别的属性（JDK7）。
  3. 每个属性的名称需要从常量池中引用一个CONSTANT_Utf8_info类型的常量来表示。

#### 详细的属性讲解

1. Code属性

   * 作用：存储字节码指令信息。
   * 特点
     * Code属性一般出现在方法表的属性集合中。
     * 并非所有方法表都有这个属性，例如接口或者抽象类中的方法就不存在Code属性。

   * 属性表的结构

     | 类型           | 名称                   | 数量                   | 作用                                                         |
     | -------------- | ---------------------- | ---------------------- | ------------------------------------------------------------ |
     | u2             | attribute_name_index   | 1                      | 指向CONSTANT_Utf8_info类型常量的索引，常量固定值为Code，表示该属性的属性名称。 |
     | u4             | attribute_length       | 1                      | 属性值的长度。这个长度不包含attribute_name_index和attribute_length。 |
     | u2             | max_stack              | 1                      | 操作数栈深度的最大值。                                       |
     | u2             | max_locals             | 1                      | 局部变量表所需的存储空间，或者说是在调用此方法时分配的局部变量数组中的局部变量的数量，单位是Slot。 |
     | u4             | code_length            | 1                      | 字节码长度。在虚拟机中明确限制一个方法不允许超过65535条字字节码指令。 |
     | u1             | code                   | code_length            | 字节码指令。                                                 |
     | u2             | exception_table_length | 1                      | 异常处理表，用来记录字节码中这个方法的异常处理逻辑。         |
     | exception_info | exception_table        | exception_table_length | 异常处理表信息，具体可参考下面的异常处理表结构。             |
     | u2             | attributes_count       | 1                      | 属性表计数器。                                               |
     | attribute_info | attributes             | attributes_count       | 属性表集合。                                                 |

   * 异常处理表结构

     | 类型 | 名称       | 数量 | 作用                                                         |
     | ---- | ---------- | ---- | ------------------------------------------------------------ |
     | u2   | start_pc   | 1    | 字节码程序计数器异常捕获开始的行数。                         |
     | u2   | end_pc     | 1    | 字节码程序计数器异常捕获结束的行数。                         |
     | u2   | catch_type | 1    | 异常的类型或者其子类，catch_type为指向一个CONSTANT_Class_info类型常量的索引。 |
     | u2   | handler_pc | 1    | 字节码程序计数器异常处理逻辑的行数。                         |

2. Exceptions属性

   * 作用：列举出方法中可能抛出的受检查异常（Checked Exception），也就是方法定义中在throws关键字后面列举的异常。

   * Exceptions属性表结构

     | 类型 | 名称                  | 数量                 | 作用                                                         |
     | ---- | --------------------- | -------------------- | ------------------------------------------------------------ |
     | u2   | attribute_name_index  | 1                    | 指向CONSTANT_Utf8_info类型常量的索引，常量固定值为Exceptions，表示该属性的属性名称。 |
     | u4   | attribute_length      | 1                    | 属性值的长度。这个长度不包含attribute_name_index和attribute_length。 |
     | u2   | number_of_exceptions  | 1                    | 受检查异常的数量。                                           |
     | u2   | exception_index_table | number_of_exceptions | 一个指向常量池中CONSTANT_Class_info类型的常量索引，代表受检查异常的类型。 |

3. LineNumberTable属性

   * 作用：描述Java源码行号和字节码行号之间的对应关系。默认会生成到Class文件中，可以在javac命令中分别使用`-g:none`或`-g:lines`选项来取消或要求生成这项信息。

   * 影响：若不生成该项信息，当抛出异常时，堆栈中将不会显示Java代码中出错的行号。

   * LineNumberTable属性结构

     | 类型             | 名称                     | 数量                     | 作用                                                         |
     | ---------------- | ------------------------ | ------------------------ | ------------------------------------------------------------ |
     | u2               | attribute_name_index     | 1                        | 指向CONSTANT_Utf8_info类型常量的索引，常量固定值为LineNumberTable，表示该属性的属性名称。 |
     | u4               | attribute_length         | 1                        | 属性值的长度。这个长度不包含attribute_name_index和attribute_length。 |
     | u2               | line_number_table_length | 1                        | line_number_info类型的数量。                                 |
     | line_number_info | line_number_table        | line_number_table_length | 行号信息集合。                                               |

   * line_number_info类型结构

     | 类型 | 名称        | 数量 | 作用         |
     | ---- | ----------- | ---- | ------------ |
     | u2   | start_pc    | 1    | 字节码行号   |
     | u2   | line_number | 1    | Java源码行号 |

     