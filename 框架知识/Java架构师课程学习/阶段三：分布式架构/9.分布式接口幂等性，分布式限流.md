# 17周 分布式接口幂等性，分布式限流

## 第一章 分布式接口幂等性

### 1-1 概述与接口重试的问题

#### 1. 本章概述

* 什么是幂等性
* 幂等性设计的核心思想
* select、update、delete、insert和混合操作的接口幂等性

#### 2. 接口设计与重试机制引发的问题

1. 提交订单按钮如何防止重复提交
2. 表单录入页如何防止重复提交
3. 微服务接口，客户端重试时，会对业务数据产生影响吗？

#### 3. 接口幂等性

> 参考文章：https://juejin.cn/post/6844903815552958477

1. 幂等性：f(f(x)) = f(x)
2. 幂等性元素运行多次，还等于它原来的运算结果
3. 在系统中，一个接口运行多次，与运行一次的效果是一致的
4. 要考虑幂等性设计的场景：重复提交，接口重试，前端操作抖动等
5. 示例场景：
   * 用户多次点击提交订单，后台应只生成一个订单
   * 支付时，由于网络问题重发，应该只扣一次钱
6. 注意：并不是所有的接口都要求幂等性设计，要根据业务而定
7. **幂等性设计的核心思想**：通过唯一的业务单号保证幂等性
8. 并发情况下的幂等性设计：整个业务逻辑过程要加锁
9. 非并发情况下的幂等性设计：查询业务单号有没有操作过，没有则执行操作
10. 相关数据库操作幂等性设计原则：
    * Select操作：不会对业务数据有影响，天然幂等
    * Delete操作：多次操作结果一致，天然幂等
    * Updata操作：更新操作传入数据版本号，通过乐观锁实现幂等性
    * Insert操作：此时没有唯一的业务单号，使用Token保证幂等
    * 混合操作：找到操作的唯一业务单号，有则可以使用分布式锁。没有可以通过Token保证幂等，这里根据token来添加分布式锁保证请求的幂等性。

### 1-2 update操作的幂等性

#### 基于乐观锁实现幂等性（版本号机制）

1. 实现逻辑

   - 取出记录时，获取当前`version`
   - 更新时，带上这个`version`
   - 执行更新时， `set version = newVersion where version = oldVersion`
   - 如果`version`不对，就更新失败

2. 核心SQL

   ```sql
   update table set name = 'Aron', version = version + 1 where id = #{id} and version = #{version};  
   ```

3. 观点

   乐观锁的版本号机制可以勉强以 `token` 或者`状态标识` 作为版本号来实现幂等性。

#### 



