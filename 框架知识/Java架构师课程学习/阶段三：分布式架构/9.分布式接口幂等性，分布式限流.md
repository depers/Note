# 17周 分布式接口幂等性，分布式限流

## 第一章 分布式接口幂等性

### 1-1 概述与接口重试的问题

#### 1. 本章概述

* 什么是幂等性
* 幂等性设计的核心思想
* select、update、delete、insert和混合操作的接口幂等性

#### 2. 接口设计与重试机制引发的问题

1. 提交订单按钮如何防止重复提交
2. 表单录入页如何防止重复提交
3. 微服务接口，客户端重试时，会对业务数据产生影响吗？

#### 3. 接口幂等性

> 参考文章：https://juejin.cn/post/6844903815552958477

1. 幂等性：f(f(x)) = f(x)
2. 幂等性元素运行多次，还等于它原来的运算结果
3. 在系统中，一个接口运行多次，与运行一次的效果是一致的
4. 要考虑幂等性设计的场景：重复提交，接口重试，前端操作抖动等
5. 示例场景：
   * 用户多次点击提交订单，后台应只生成一个订单
   * 支付时，由于网络问题重发，应该只扣一次钱
6. 注意：并不是所有的接口都要求幂等性设计，要根据业务而定
7. **幂等性设计的核心思想**：通过唯一的业务单号保证幂等性
8. 并发情况下的幂等性设计：整个业务逻辑过程要加锁
9. 非并发情况下的幂等性设计：查询业务单号有没有操作过，没有则执行操作
10. 相关数据库操作幂等性设计原则：
    * Select操作：不会对业务数据有影响，天然幂等
    * Delete操作：多次操作结果一致，天然幂等
    * Updata操作：更新操作传入数据版本号，通过乐观锁实现幂等性
    * Insert操作：此时没有唯一的业务单号，使用Token保证幂等
    * 混合操作：找到操作的唯一业务单号，有则可以使用分布式锁。没有可以通过Token保证幂等，这里根据token来添加分布式锁保证请求的幂等性。

### 1-2 update操作的幂等性

#### 基于乐观锁实现幂等性（版本号机制）

1. 实现逻辑

   - 在数据库表设计的时候将将`version`字段添加到表字段中
   - 取出记录时，获取当前`version`
   - 更新时，带上这个`version`
   - 执行更新时， `set version = newVersion where version = oldVersion`
   - 如果`version`不对，就更新失败

2. 核心SQL

   ```sql
   update table set name = 'Aron', version = version + 1 where id = #{id} and version = #{version};  
   ```

3. 观点

   乐观锁的版本号机制可以勉强以 `token` 或者`状态标识` 作为版本号来实现幂等性。

### 1-3 自己对幂等性的理解和整理

感觉这个视频的作者对并发和幂等性的了解也不深入，具体看一下我在notion中整理的笔记：[幂等性/并发/防重放](https://phrygian-earwig-e60.notion.site/2f1c31dfa08d40418e63d59fddfc40e8)

对于mall项目的幂等性控制，这里我采用**redis去重进行幂等性校验**

## 第二章 分布式限流

### 2-1 章节内容介绍

* 分布式限流介绍
  * 常见方案
  * 技术选型
* 分布式限流常用算法
* 基于客户端的限流方案
  * [demo] Guava RateLimiter客户端限流
  * [算法源码] Guava的预热模型
* 基于Nginx的分布式限流
  * [demo] 基于IP地址的限流方案
  * [demo]基于最大连接数的限流方案
* 基于Redis + Lua的分布式限流
* 30分钟了解Lua
  * [demo] Lua基本用法和介绍
  * [demo] Redis预加载Lua
* 电商项目改造 - 客户端分布式限流
  * [demo] 基于Redis + Lua实现限流
  * [demo] 定义自定义注解封装限流逻辑
* 课程小节与作业

### 2-2 分布式限流介绍

![](../../../笔记图片/20/3-9/2-2.png)

### 2-3 分布式限流的几种方案

![](../../../笔记图片/20/3-9/2-3.png)

### 2-4 限流方案常用算法讲解

下列图片中关于滑动窗口算法的讲解，我觉得不是很准确。关于限流的算法还可以参考《Java并发编程》第15章第二节的内容。

![](../../../笔记图片/20/3-9/2-4.png)

### 2-5 【Demo】Guava RateLimiter客户端限流（阻塞模式）

创建rate-limit子项目，引入依赖项

非阻塞式的限流方案

同步阻塞式的限流方案

https://www.cnblogs.com/fnlingnzb-learner/p/13086185.html

### 2-6 Guava RateLimiter预热模型

在流量预热的做法的折线图中，以横坐标为准，从右到左是流量从忙时变为闲时的过程，令牌的速率逐渐降低，从左到右是流量从闲时变为忙时的过程，令牌的发放速率逐渐加快。

![](../../../笔记图片/20/3-9/2-7.png)

